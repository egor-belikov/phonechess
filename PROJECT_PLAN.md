# PhoneChess — план проекта

Telegram Mini App (Web App) для онлайн-шахмат: бэкенд Python, фронтенд JavaScript. Игра только в браузере Telegram с телефона.

---

## 1. Контроли времени и лобби

### Режимы (6 кнопок в лобби)
| Режим | Блиц/Рапид | Старт | Инкремент |
|-------|------------|-------|-----------|
| 3+0   | Blitz      | 3 мин | 0         |
| 3+2   | Blitz      | 3 мин | 2 сек     |
| 5+0   | Blitz      | 5 мин | 0         |
| 5+3   | Blitz      | 5 мин | 3 сек     |
| 10+0  | Rapid      | 10 мин| 0         |
| 15+10 | Rapid      | 15 мин| 10 сек    |

- На каждой кнопке: **текст режима** (например «3+0») и **счётчик очереди** — «N в очереди» (сколько человек ждёт матч в этом режиме).
- Под кнопками — **топ партий для просмотра**: список игр, отсортированный по среднему рейтингу игроков (можно лимит 5–10), клик — переход к просмотру.

### Пейринг
- При нажатии на кнопку режима: если есть ждущий в очереди — сразу создаётся партия; если нет — пользователь попадает в очередь.
- Очередь по режиму (и по типу: обычная / приватная) хранится на бэкенде, счётчики обновляются в реальном времени (WebSocket/SSE).

---

## 2. Интерфейс игры (мобильный, как на Lichess)

- **Доска:** стиль Lichess (светлые/тёмные клетки, чёткие фигуры).
- **Ввод хода:**
  - Перетаскивание фигуры (drag & drop).
  - Либо: нажатие на фигуру → подсветка легальных полей → нажатие на поле для хода.
- **Валидация:** только легальные ходы; при шахе — **красная обводка короля**.
- **Часы:** над доской, два таймера (игрок снизу доски / соперник сверху). Стиль как на Lichess.
- **Таймер:** если осталось **< 20 секунд** — таймер красный и показываются **миллисекунды** (для обоих игроков).
- **Список ходов:** под доской — ходы в шахматной нотации + время на ход (как на Chess.com): например `e4 (0:02)`.

---

## 3. Аутентификация и сессии

### Вход через Telegram
- Использовать **Telegram Web App initData** для проверки пользователя (подпись от бота).
- **Один аккаунт — один активный логин:** при входе с нового устройства/сессии предыдущая сессия инвалидируется; новая попытка входа с другого места видит **сплэш «Вы вошли в другом месте»** и не получает доступ к игре.

### Регистрация (новый Telegram-аккаунт)
- Если `telegram_id` ещё не в базе — показать **экран регистрации**: ввод **логина**.
- Правила логина: только `a-z`, `A-Z`, `0-9`, `_`, `-`; макс. **15 символов**; уникальность по всей базе.

### Хранение
- В БД: `user_id` (PK), `telegram_id` (unique), `username` (unique), `created_at`, рейтинги (blitz_rating, rapid_rating), язык, тема и т.д.
- Сессии: `session_id`, `user_id`, `token`/`refresh_token`, `last_active`, чтобы отзывать старые логины.

---

## 4. Язык и тема

- **Языки:** русский и английский. Переключатель в **верхнем меню**.
- **Тема:** дневная / ночная. По умолчанию — **ночная**. Кнопка переключения в верхнем меню.
- Сохранение выбора в профиле (и в localStorage для быстрого отображения до загрузки профиля).

---

## 5. Верхнее меню

- Язык (RU / EN).
- Тема (день / ночь).
- **Профиль** — переход в профиль: рейтинг (блиц/рапид), история партий, настройки.

---

## 6. Профиль и рейтинг

- **Рейтинг Эло:**
  - **Blitz:** режимы 3+0, 3+2, 5+0, 5+3. Один рейтинг blitz.
  - **Rapid:** режимы 10+0, 15+10. Один рейтинг rapid.
  - Стартовый рейтинг: **1500** для каждого пула.
- В профиле: отображение blitz/rapid, количество игр.
- **История партий:** список партий с результатом, датой, соперником. При выборе партии — **просмотр по ходам** (доска + список ходов с пошаговой навигацией).

---

## 7. Приватные игры

- В лобби отдельная кнопка: **«Приватная игра»**.
- После нажатия — выбор одного из **шести контролей** (те же 3+0 … 15+10).
- Затем кнопка **«Пригласить друга»**: генерация ссылки (например `https://t.me/bot?start=invite_<game_token>`) и отправка через **Telegram Share** (share в контакт/чат). Друг переходит по ссылке и попадает в ожидание/партию.
- Партия создаётся только когда оба в «комнате»; таймер стартует после первого хода (как обычно).

---

## 8. Просмотр чужих партий (зрители)

- В лобби под кнопками режимов — блок **«Топ партий»**: игры, отсортированные по среднему рейтингу игроков.
- Клик — открытие партии в режиме **только просмотр** (доска, часы, список ходов в реальном времени, без возможности хода).

---

## 9. Поведение при закрытии/сворачивании

- **Закрытие вкладки/окна:** считать, что игрок **покинул партию** → засчитать **поражение**, сопернику — победа, обновить рейтинги.
- **Сворачивание:** по возможности отслеживать (например Page Visibility API) и при длительном сворачивании (например > 30–60 сек без возврата) трактовать как отключение и засчитывать поражение. Логику и порог вынести в настройки (в плане можно зафиксировать 60 сек).
- На бэкенде: таймаут хода = контроль времени игрока; если время вышло или зафиксирован «уход» — завершение партии по правилам.

---

## 10. Хостинг и узкий канал VPS

Отдельный документ: **HOSTING.md** — варианты размещения с учётом ограниченного канала (CDN, статика на edge, минимальный трафик с VPS, serverless и т.д.).

---

## 11. Технический стек (рекомендации)

### Бэкенд (Python)
- **Framework:** FastAPI (async, WebSockets, OpenAPI).
- **БД:** PostgreSQL (пользователи, партии, рейтинги, очереди).
- **Очереди/кэш:** Redis — очереди пейринга, активные сессии, таймеры партий.
- **Realtime:** WebSockets для игры и лобби (ходы, часы, счётчики очереди, список топ-партий).

### Фронтенд (JavaScript)
- **Без тяжёлых фреймворков** (или лёгкий) — чтобы быстро грузиться в Telegram WebView: ванильный JS или Preact.
- **Шахматная логика:** библиотека на JS (например chess.js) для валидации ходов и генерации легальных полей.
- **Доска:** свой рендер (Canvas или DOM) в стиле Lichess; спрайты фигур оптимизированы (SVG или один PNG sprite).
- **Связь:** WebSocket к бэкенду; fallback на long polling при проблемах с WS в WebView.

### Telegram
- **Bot API:** бот с кнопкой/командой, открывающей Web App (Menu Button или Inline Keyboard).
- **Web App initData:** проверка подписи на бэкенде (secret key от Bot API), извлечение `user` (telegram_id, username и т.д.).

---

## 12. Структура репозитория (предложение)

```
phonechess/
├── PROJECT_PLAN.md          # этот файл
├── HOSTING.md               # хостинг при узком канале
├── backend/
│   ├── app/
│   │   ├── main.py
│   │   ├── config.py
│   │   ├── auth.py           # Telegram initData, сессии, один логин
│   │   ├── pairing.py        # очереди, пейринг
│   │   ├── game.py          # партия, таймеры, рейтинг
│   │   ├── models/          # User, Game, Session
│   │   ├── api/              # REST: profile, history, invite
│   │   └── ws/               # WebSocket: lobby, game, spectate
│   ├── requirements.txt
│   └── Dockerfile
├── frontend/
│   ├── index.html
│   ├── app.js
│   ├── chess.js             # обёртка над chess.js, легальные ходы
│   ├── board.js             # отрисовка доски, drag, подсветка
│   ├── ui/                  # лобби, игра, профиль, настройки
│   ├── i18n/                # ru, en
│   ├── assets/              # фигуры, иконки
│   └── styles/              # темы day/night, Lichess-like
└── docker-compose.yml       # app + postgres + redis (опционально)
```

---

## 13. Этапы разработки (кратко)

1. **Скелет:** бэкенд (FastAPI + проверка initData), фронт (лобби + одна страница игры), WebSocket — вход в очередь и создание тестовой партии.
2. **Игра:** часы, ходы, валидация, отказ при нелегальном ходе, шах/мат, завершение по времени/сдаче.
3. **UI под телефон:** доска Lichess-like, drag & drop, подсветка ходов, красный король при шахе, таймер с миллисекундами при < 20 сек, список ходов с временем.
4. **Рейтинг и профиль:** Elo blitz/rapid, история партий, просмотр по ходам.
5. **Локализация и тема:** RU/EN, день/ночь, верхнее меню.
6. **Приватные игры:** инвайт-ссылка, приглашение в ТГ.
7. **Топ партий и зрители:** список в лобби, просмотр в реальном времени.
8. **Один логин:** сессии, сплэш при повторном входе; обработка закрытия/сворачивания (поражение за выход).
9. **Регистрация:** экран логина для новых пользователей, валидация username.
10. **Деплой и хостинг:** по HOSTING.md с учётом узкого канала.

После этого можно переходить к реализации по шагам и при необходимости уточнять детали в плане.
