# Хостинг PhoneChess при узком канале VPS

Если у VPS маленький исходящий канал, основная идея: **как можно меньше трафика отдавать с самого VPS**, а статику и часть запросов обслуживать через CDN или внешние сервисы.

---

## 1. Что съедает канал

- **Статика:** HTML, CSS, JS, картинки/спрайты фигур, шрифты — при каждом заходе и обновлении.
- **API и WebSocket:** запросы к бэкенду, постоянное соединение WS во время игры.

При узком канале статика может создавать основную нагрузку, особенно при росте числа пользователей.

---

## 2. Схема: статика в CDN, VPS только API и WebSocket

### Идея
- **Статические файлы** (всё, что не меняется при каждом запросе) отдавать через **CDN** с большим каналом и кэшем.
- На **VPS** оставить только:
  - приложение (FastAPI),
  - WebSocket,
  - база и Redis (или они тоже могут быть вынесены, см. ниже).

Тогда по узкому каналу идут в основном мелкие JSON-ответы и WebSocket-кадры, а не мегабайты JS/CSS.

### Как вынести статику

**Вариант A: Отдельный хостинг статики**

- Собрать фронт в папку (например `dist/`) и залить на:
  - **Cloudflare Pages** (бесплатно),
  - **Vercel** (бесплатный тариф),
  - **GitHub Pages**,
  - **Netlify**.
- Домен/поддомен для статики (например `app.phonechess.com`) указывает на этот хостинг.
- В настройках фронта **API_URL** и **WS_URL** указывают на твой VPS (например `api.phonechess.com`).
- Итог: первый заход и обновления грузят статику с CDN; VPS отдаёт только API + WS.

**Вариант B: CDN перед всем приложением**

- Поставить перед VPS **Cloudflare** (или другой CDN) как прокси.
- Включить кэширование по правилам: кэшировать пути типа `/`, `/assets/*`, `*.js`, `*.css`, `*.png`, с длинным TTL.
- Само приложение на VPS отдаёт и HTML, и статику, но CDN забирает трафик по кэшируемым URL. Минус: первый запрос и инвалидация кэша всё равно идут на VPS, поэтому для сильного ограничения канала лучше Вариант A.

---

## 3. Минимизация трафика с VPS

- **Сжатие:** включить gzip/brotli для всех ответов (FastAPI через GZipMiddleware или nginx).
- **Маленькие ответы API:** не отдавать лишние поля, пагинация списков (история партий, топ партий).
- **WebSocket:** передавать только необходимые события (ход, обновление часов, счётчики очереди) в компактном формате (короткие ключи JSON или бинарный протокол при росте нагрузки).
- **Один бандл фронта:** минификация и при необходимости разбиение на chunks так, чтобы повторные заходы могли брать часть из кэша.

---

## 4. Где держать бэкенд, если канал очень узкий

- **Оставить только бэкенд на VPS:** статику — в CDN/Pages (как в п. 2A), на VPS только API + WebSocket. Это сильно снижает пиковый трафик с VPS.
- **Перенести бэкенд туда, где канал не ограничен:**
  - **Serverless (AWS Lambda, Cloudflare Workers, Yandex Cloud Functions):** подходят для REST API; для WebSocket нужна поддержка long-lived соединений (например, отдельный сервис или Workers с Durable Objects / внешний WS-сервер). Можно сделать гибрид: API на serverless, WebSocket на маленьком VPS или на сервисе вроде Railway/Render.
  - **PaaS с нормальным каналом:** Railway, Render, Fly.io, Heroku — поднять контейнер с приложением; канал обычно не такой узкий, как у дешёвого VPS.
- **База и Redis:** можно вынести в managed-сервисы (например, в облако провайдера), чтобы с VPS не шёл лишний трафик к БД по интернету; если БД на том же VPS — тогда только исходящий трафик к клиентам критичен.

---

## 5. Рекомендуемая конфигурация при узком канале

1. **Фронт** — на **Cloudflare Pages** или **Vercel** (домен вида `app.phonechess.com`).
2. **Бэкенд** — оставить на **VPS** только для API и WebSocket; включить gzip; ответы компактные.
3. **Перед VPS** — **Cloudflare** (бесплатный план) как reverse proxy: DDoS-защита и кэш для любых случайных запросов к статике, если они пойдут на VPS.
4. **База и Redis** — по возможности на том же VPS (localhost) или в одной сети, чтобы не тратить канал на обмен с БД.

Если позже окажется, что и этого канала не хватает — переносить только бэкенд на Railway/Render/Fly.io, оставив статику на CDN.

---

## 6. Docker и деплой на VPS

- Образ только для API + WebSocket (без раздачи статики или с минимальной «заглушкой» для health check).
- Пример `docker-compose`: сервисы `app`, `postgres`, `redis`; наружу только порт приложения (например 8000), nginx или Caddy перед ним — по желанию (можно и без них, если приложение слушает 0.0.0.0).
- Переменные окружения: `DATABASE_URL`, `REDIS_URL`, `TELEGRAM_BOT_TOKEN`, секрет для проверки Web App initData.

---

## 7. Краткий чеклист

- [ ] Статику отдавать с CDN (Cloudflare Pages / Vercel), не с VPS.
- [ ] На VPS только API + WebSocket, сжатие ответов включено.
- [ ] Перед VPS — Cloudflare proxy (опционально, но полезно).
- [ ] В коде фронта: `API_URL` и `WS_URL` на адрес VPS (или домен за Cloudflare).
- [ ] База/Redis по возможности рядом с приложением (тот же хост или приватная сеть).

Так можно комфортно хостить приложение даже при очень узком канале VPS.
